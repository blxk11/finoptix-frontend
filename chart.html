<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portfolio Analysis â€“ Finoptix</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #1b1f36;
      margin-bottom: 20px;
    }
    canvas {
      max-width: 800px;
      margin: 20px auto;
      display: block;
    }
    table {
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      font-size: 14px;
      text-align: center;
    }
    th {
      background-color: #eff6ff;
    }
    td.positive { color: green; font-weight: 600; }
    td.negative { color: red; font-weight: 600; }
  </style>
</head>
<body>

<h1>Your Portfolio Performance</h1>

<canvas id="pieChart"></canvas>
<canvas id="barChart"></canvas>
<canvas id="lineChart"></canvas>

<table id="resultTable">
  <thead>
    <tr>
      <th>Stock</th>
      <th>Qty</th>
      <th>Buy Price</th>
      <th>Current Price</th>
      <th>Gain (%)</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  let rawData = JSON.parse(localStorage.getItem("portfolioData") || "[]");

  const pieCtx = document.getElementById("pieChart").getContext("2d");
  const barCtx = document.getElementById("barChart").getContext("2d");
  const lineCtx = document.getElementById("lineChart").getContext("2d");

  const pieChart = new Chart(pieCtx, {
    type: "pie",
    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
    options: {
      plugins: {
        title: { display: true, text: "Portfolio Allocation" },
        legend: { position: "bottom" }
      }
    }
  });

  const barChart = new Chart(barCtx, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: "Gain/Loss (%)",
        data: [],
        backgroundColor: [],
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: "Stock Gain/Loss %" },
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  const lineChart = new Chart(lineCtx, {
    type: "line",
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "Live Price Movement (Top Stocks)"
        },
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  function updateTable(data) {
    const body = document.getElementById("tableBody");
    body.innerHTML = "";
    data.forEach(stock => {
      const gainClass = stock["Gain (%)"] >= 0 ? "positive" : "negative";
      body.innerHTML += `
        <tr>
          <td>${stock["Stock Name"]}</td>
          <td>${stock["Quantity"]}</td>
          <td>${stock["Buy Price"]}</td>
          <td>${stock["Current Price"]}</td>
          <td class="${gainClass}">${stock["Gain (%)"]}%</td>
        </tr>
      `;
    });
  }

  async function fetchLiveData() {
    const res = await fetch("/api/data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rawData)
    });
    const updated = await res.json();
    rawData = updated;
    localStorage.setItem("portfolioData", JSON.stringify(updated));
    refreshCharts(updated);
    updateTable(updated);
  }

  function refreshCharts(data) {
    const labels = data.map(s => s["Stock Name"]);
    const allocations = data.map(s => s["Quantity"] * s["Current Price"]);
    const gains = data.map(s => s["Gain (%)"]);
    const bgColors = labels.map((_, i) => `hsl(${i * 45 % 360}, 70%, 70%)`);

    pieChart.data.labels = labels;
    pieChart.data.datasets[0].data = allocations;
    pieChart.data.datasets[0].backgroundColor = bgColors;
    pieChart.update();

    barChart.data.labels = labels;
    barChart.data.datasets[0].data = gains;
    barChart.data.datasets[0].backgroundColor = bgColors;
    barChart.update();

    // Line chart: simulate price movement for top 3 stocks
    const top3 = data.slice(0, 3);
    const now = new Date();
    const timeLabels = Array.from({ length: 6 }, (_, i) =>
      new Date(now.getTime() - (5 - i) * 60000).toLocaleTimeString()
    );

    lineChart.data.labels = timeLabels;
    lineChart.data.datasets = top3.map((s, idx) => ({
      label: s["Stock Name"],
      data: Array.from({ length: 6 }, () =>
        (s["Current Price"] * (1 + Math.random() * 0.01 - 0.005)).toFixed(2)
      ),
      borderColor: `hsl(${idx * 120}, 70%, 50%)`,
      fill: false,
      tension: 0.2
    }));
    lineChart.update();
  }

  refreshCharts(rawData);
  updateTable(rawData);

  setInterval(fetchLiveData, 60000); // Update every 60s
</script>
</body>
</html>
